---
title: "SeaCuc-DataAnalysis"
author: "Hannia Larino"
date: "2025-05-27"
output: html_document
---

**PART II. RUNNING DESeq2**

*First, pre-process data!*
Reading in countmatrix
```{r}
countmatrix <- read.table("~/SeaCucumber/output/kallisto_01.isoform.counts.matrix", header = TRUE, row.names = 1)
head(countmatrix)
```


Filtering according to smallest treatment size of 3.

```{r}
# Load counts
counts <- read.table("~/SeaCucumber/output/kallisto_01.isoform.counts.matrix", header=TRUE, row.names=1)

# Filter: keep rows with counts >5 in at least 3 samples
keep <- rowSums(counts > 5) >= 3
filtered.counts <- counts[keep, ]

# Summary
cat("Before filtering:", nrow(counts), "isoforms\n")
cat("After filtering:", nrow(filtered_counts), "isoforms\n")
```

Rounding up data to nearest whole number bc DESeq2 does not take decimals
```{r}
countmatrix <- round(filtered.counts, 0)
str(filtered.counts)
```
```{r}
filtered.counts
```


Loading libraries to be used for DESeq2
```{r}
library(DESeq2)
library(tidyverse)
library(pheatmap)
library(RColorBrewer)
library(data.table)
```


Creating vector that renames file ID to meaningful ID

```{r}
# Vector of new sample names in the correct order (must match column order in counts)
new.names <- c("Control1", "Control2", "Control3", "26_a1", "26_a2", "26_a3", "26_b1", "26_b2", "26_b3", "30_a1","30_a2","30_a3")

# Apply new names to the columns
colnames(filtered.counts) <- new.names
colnames(filtered.counts)
head(filtered.counts)

```





Telling R we have 3 conditions and the control. 
```{r}
# Vector of conditions corresponding to each sample
condition <- factor(condition, levels = c("Control", "26_a", "26_b", "30_a"))
condition
```
Trying to filter counts to nearest integer again

```{r}
filtered.counts <- round(filtered.counts, 0)
```



```{r}
deseq2.colData <- data.frame(condition = condition, 
                             type=factor(rep("paired", 12)))

rownames(deseq2.colData) <- colnames(filtered.counts)

deseq2.dds <- DESeqDataSetFromMatrix(countData = filtered.counts,
                                     colData = deseq2.colData, 
                                     design = ~ condition)
```
Finally getting the DGE analysis from deseq2.res 
```{r}
deseq2.dds <- DESeq(deseq2.dds)
deseq2.res <- results(deseq2.dds)
deseq2.res <- deseq2.res[order(rownames(deseq2.res)), ]
```
Try to find out how to view results for the other 2 conditons. 
```{r}
deseq2.res
```

explore the results from below chunk 
```{r}
# Count number of hits with adjusted p-value less then 0.05
dim(deseq2.res[!is.na(deseq2.res$padj) & deseq2.res$padj <= 0.05, ])
```
```{r}
head(deseq2.res[order(deseq2.res$padj), ])  # sorted by adjusted p-value
```





VISUALIZATION BELOW 

Heat map from assignment
```{r}
tmp <- deseq2.res
# The main plot
plot(tmp$baseMean, tmp$log2FoldChange, pch=20, cex=0.45, ylim=c(-3, 3), log="x", col="darkgray",
     main="DEG of 2 temperatures  (pval <= 0.05)",
     xlab="mean of normalized counts",
     ylab="Log2 Fold Change")

# Getting the significant points and plotting them again so they're a different color
tmp.sig <- deseq2.res[!is.na(deseq2.res$padj) & deseq2.res$padj <= 0.05, ]
points(tmp.sig$baseMean, tmp.sig$log2FoldChange, pch=20, cex=0.45, col="red")
# 2 FC lines
abline(h=c(-1,1), col="blue")
```






